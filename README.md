# 基于STM32的高密度电法数据采集系统

**项目周期: 2024.11 - 2025.03**

## 1. 项目概述

本项目设计并实现了一套专业级的**高密度电法数据采集系统**，专为地质勘探领域打造。系统以高性能的 **STM32H750VBT6** 为核心，构建了一个分布式、多通道同步采集的硬件架构。通过精细的软硬件协同设计，本系统实现了微伏级的高精度数据测量、多达30路通道的灵活切换以及长达800米的可靠远程通信，成功验证了其在地质勘探复杂环境下的应用潜力。

![内部结构图](https://github.com/user-attachments/assets/59309fd1-df12-4a35-8460-1cd219a3634f)

![主机、从机实物展示图](https://github.com/user-attachments/assets/905456a4-3bf5-484b-8ef1-3d27bba718a8)


## 2. 技术特性与亮点

- **高精度数据采集**：采用3片24位高精度ADC **ADS1263**，结合内部校准与过采样平均算法，理论分辨率高达 **0.3μV**，确保了微弱地电信号的精确捕捉。
- **多通道与灵活性**：通过 **CD4067** 多路复用器，实现了**30个模拟通道**的动态切换，切换时间控制在5μs以内，支持灵活的测量阵列配置。
- **分布式架构**：基于 **RS485** 总线构建主从式通信网络，支持多点同步采样和命令分发，最大通信距离可达 **800米**，适应大规模勘探场景。
- **高可靠性通信**：实现了数据包的 **CRC校验** 和 **自动重传机制**，确保在恶劣的工业环境下数据传输的可靠性接近99.9%。
- **专业的PCB设计**：运用 **Altium Designer** 进行多层板设计，对模拟/数字部分进行物理隔离、采用保护接地和等长布线等多种抗干扰措施，从硬件层面保证了信号完整性。
- **上位机集成与扩展**：开发了基于 **MATLAB** 的上位机，实现了远程参数配置、数据实时监控与存储。同时，为系统规划了 **SIM900 (GPRS)** 模块的扩展接口，为未来实现云端数据传输和远程监控奠定了基础。

## 3. 硬件系统设计

- **主控制器**: `STM32H750VBT6` (ARM Cortex-M7 @ 480MHz)
- **ADC**: `ADS1263` x 3 (24-Bit, 32-kSPS, Delta-Sigma ADC)
- **模拟开关**: `CD4067` x 4 (16-Channel Analog Multiplexer)
- **通信接口**: `RS485` Transceiver Module

## 4. 软件系统详解

系统软件架构分为三大核心部分：数据采集、通信系统和上位机控制。

### 4.1 数据采集系统

- **ADS1263驱动**：通过**软件模拟SPI**实现与3片ADC的稳定通信。驱动库封装了寄存器读写、通道切换、增益/采样率配置和启停控制等核心功能。
- **高精度测量**：充分利用ADC的24位特性，在±2.5V内部参考电压下实现高精度测量。代码中包含了灵活的**增益配置**（高达132倍）和**采样率设置**（2.5 SPS ~ 38.4 kSPS）接口。
- **数据校准与处理**：实现了芯片内部的**系统偏移(System Offset)**和**系统增益(System Gain)**校准，并通过**过采样平均算法**进一步滤除噪声，提升信噪比。
- **多路通道控制**：开发了CD4067驱动程序，实现了30路模拟通道的快速、精确切换，为不同的电极排列方式（如温纳、偶极等）提供了软件支持。

### 4.2 通信系统

- **主从网络**：基于RS485总线实现一个主机、多个从机的通信网络。主机负责下发采集命令、同步时钟；从机负责执行命令并上传数据。
- **可靠协议**：设计了一套包含帧头、命令码、数据长度、数据负载和CRC16校验码的自定义通信协议。支持数据包校验和应答、超时重传机制。
- **功能实现**：
  - **当前状态**: 已在代码中实现了**主机向从机发送启动命令、从机返回模拟数据的通信流程**。
  - **未来规划**: 协议设计上支持设备自动识别、状态查询和固件远程更新（OTA）。

### 4.3 上位机控制系统 (MATLAB)

- **远程控制**：通过PC串口与主控制器连接，可远程配置采集参数，如采样率、增益、通道组合等。
- **数据可视化与存储**：实时接收下位机上传的采集数据，动态绘制波形，并可将数据流自动保存为`.mat`或`.csv`文件，便于后续进行**反演算法**分析。
- **自动化采集**：支持预设采集任务序列，实现一键启动、自动化流程控制，减少人工干预。

## 5. 项目源码与结构

本仓库包含主控制器`STM32H750VBT6`的Keil MDK工程源码。

- `main.c`: 主业务逻辑，包括系统初始化、命令解析、任务调度和主循环。
  - **代码说明**: `main.c`中的主循环当前展示了**主机与从机通过RS485进行模拟数据交互的流程**。真实的电极切换和三路ADC同步采集的详细循环逻辑已被注释，以方便进行功能演示和模块化调试。
- `/Drivers`: 存放HAL库和CMSIS核心文件。
- `/Core`: 存放核心业务代码。
  - `ads1263.c/.h`: 第一片ADS1263的底层驱动。
  - `ads1263_2.c/.h`, `ads1263_3.c/.h`: 第二、三片ADC的驱动（基于第一版适配）。
  - `rs485_master.c/.h`: RS485主机通信协议栈。
  - `gpio.c`, `usart.c`: STM32CubeMX生成的硬件初始化代码。
- `/User`: 用户自定义模块。

## 6. 未来展望

-  **完善分布式采集**: 完成从机端的固件开发，实现真正的多点同步数据采集。
-  **集成GPRS模块**: 将`SIM900`模块集成到系统中，通过GPRS网络将数据实时上传至云服务器，实现远程无人值守监控。
-  **低功耗优化**: 针对野外长期部署场景，优化系统功耗，增加休眠和唤醒机制。
- **嵌入式GUI**: 考虑在主控制器上增加小型触摸屏，实现现场参数配置和简单的波形显示。

---
